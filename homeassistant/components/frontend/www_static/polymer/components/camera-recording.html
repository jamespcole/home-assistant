<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<polymer-element name="camera-recording" attributes="cameraImageEvent">
<template>
	<style>
		:host .camera-event-thumb {
			width: calc(90%);
			display:inline;
		}
		:host .camera-thumb-list-item {
			min-width: calc(10%);
			max-width: calc(10%);
			display:inline;
		}


		:host .playback-controls {
			text-align:center;
			text-align:-webkit-center;
		}

		:host .selected-frame {
			border: solid #4285f4 2px;
		}

		:host .strip-container {
			width:630px;
		}

        :host .camera-recording-container {
            width:640px;
            height:520px;
        }

        :host .camera-image-holder {
            text-align: center;
        }

        :host .camera-event-image {
            height:360px;

        }

		@media (max-width: 780px) {
            :host .camera-event-image {
                width: calc(100%);
                height: initial;
            }
            :host .camera-recording-container {
                width: calc(100%);
                height: calc(100%);
            }
            :host .strip-container {
                width: calc(100% - 10px);
            }
            :host .camera-thumb-list-item {
                min-width: calc(20%);
                max-width: calc(20%);
                display:inline;
            }
	    }


	</style>
	<div class='camera-recording-container' id='container'>
		<div center horizontal layout>
			<div>
				<!--<core-tooltip label="Back to Events" position="right">
					<paper-icon-button on-click="{{closeCameraEvent}}" icon="highlight-remove"></paper-icon-button>
				</core-tooltip>-->
				<paper-button on-click="{{closeCameraEvent}}">
					<paper-icon-button icon="image:navigate-before"></paper-icon-button>
					Go Back
				</paper-button>
			</div>
			<div flex>
				&nbsp;
			</div>
			<div>
				{{currentImage.time}}
			</div>
		</div>
		<!--<div horizontal layout center>-->
		<div class='camera-event'>
            <div class="camera-image-holder">
                <img class='camera-event-image' src="{{currentImage.url}}" />
            </div>

			<div horizontal layout>
				<div>
					&nbsp;
				</div>
				<div flex class='playback-controls'>
					<core-tooltip label="Play/Pause" position="bottom">
						<paper-icon-button on-click="{{togglePlaying}}" icon="{{playIcon}}"></paper-icon-button>
					</core-tooltip>
				</div>
				<div>
					&nbsp;
				</div>
			</div>
			<div horizontal layout class="strip-container">
				<div>
					<core-tooltip label="Previous Frames" position="bottom">
						<paper-icon-button on-click="{{changeStripImagesBackward}}" icon="chevron-left"></paper-icon-button>
					</core-tooltip>
				</div>
				<div flex>
					<div layout horizontal wrap id='camera_strip'>
						<template repeat="{{cameraImage, cameraImageIndex in displayedImages}}">
					      <div flex class='camera-thumb-list-item'>
					      	<img class='camera-event-thumb {{cameraImage.classname}}' data-strip-index='{{cameraImage.position}}' src="{{cameraImage.url}}" on-click='{{selectFrame}}' />
					      	<!--{{cameraImage.position}}-->
					      </div>
						</template>
					</div>
				</div>
				<div>
					<core-tooltip label="Next Frames" position="bottom">
						<paper-icon-button on-click="{{changeStripImagesForward}}" icon="chevron-right"></paper-icon-button>
					</core-tooltip>
				</div>
			</div>
		</div>
	</div>

</template>
<script>
  var storeListenerMixIn = window.hass.storeListenerMixIn;

  Polymer({
    cameraImageEvent: null,
    currentImage: null,
    currentIndex: null,
    timer: null,
    playing: false,
    playIcon: 'av:play-circle-outline',
    displayedImages: [],
    imagesInStrip: 10,
    groupedImages: [],
    currentGroupIndex: null,


    cameraImageEventChanged: function(oldval, newval) {
    	if(newval && newval.images) {
    		this.playing = false;
    		this.groupedImages = [];
    		this.currentIndex = 0;

            if( window.innerWidth <= 780) {
                this.imagesInStrip = 5;
            }
            else if( window.innerWidth > 780) {
                this.imagesInStrip = 10;
            }

            this.groupFrames();

    	}
    	else {
    		this.playing = false;
    		this.currentIndex = null;
    		this.currentImage = null;
    		this.currentGroupIndex = null;
    		this.groupedImages = [];
    	}
    },

    groupFrames: function() {
        // This groups the images together for display in the strip of frames below the main image
        var count = 0;
        var currentGroup = 0;
        this.groupedImages[currentGroup] = [];
        for(var i = 0; i < this.cameraImageEvent.images.length; i++) {
            if(count == this.imagesInStrip) {
                count = 0;
                currentGroup++;
                this.groupedImages[currentGroup] = [];
            }
            this.cameraImageEvent.images[i].position = i;
            this.groupedImages[currentGroup][count] = this.cameraImageEvent.images[i];

            count++;
        }
        this.currentGroupIndex = 0;
    },

    closeCameraEvent: function(e) {
    	this.cameraImageEvent = null;
    },

    togglePlaying: function(e) {
    	if(this.playing) {
    		clearInterval(this.timer);
    		this.playing = false;
    	}
    	else {
    		this.timer = setInterval(function() {
    			this.showNextFrame();
    		}.bind(this), 300);
    	}
    },

    showNextFrame: function() {
    	if(!this.cameraImageEvent) {
    		clearInterval(this.timer);
    		this.playing = false;
    		return;
    	}
    	this.playing = true;
    	this.currentIndex++;
    	if(this.currentIndex >= this.cameraImageEvent.images.length) {
    		this.currentIndex = 0;
    	}

    	this.highlightCurrentFrame();
    },

    playingChanged: function(oldval, newval) {
    	if(newval === true) {
    		this.playIcon = 'av:pause-circle-outline';
    	}
    	else {
    		this.playIcon = 'av:play-circle-outline';
    	}
    },

    currentGroupIndexChanged: function(oldval, newval) {
    	if(newval != null && newval < this.groupedImages.length) {
    		this.displayedImages = this.groupedImages[this.currentGroupIndex];
    	}
    },

    changeStripImages: function(forward) {
    	var imagesBuffer = [];
    	if(!this.cameraImageEvent) {
    		return;
    	}

    	if(forward) {
    		if(this.currentGroupIndex + 1 >= this.groupedImages.length) {
    			this.currentGroupIndex = 0;
    		}
    		else {
    			this.currentGroupIndex++;
    		}
    	}
    	else {
    		if(this.currentGroupIndex - 1 < 0) {
    			this.currentGroupIndex = this.groupedImages.length - 1;
    		}
    		else {
    			this.currentGroupIndex--;
    		}
    	}
    },

    changeStripImagesForward: function(e) {
    	this.changeStripImages(true);
    },

    changeStripImagesBackward: function(e) {
		this.changeStripImages(false);
    },

    highlightCurrentFrame: function() {
    	if(this.playing) {
    		var start = this.currentGroupIndex * this.imagesInStrip;
    		var end = start + this.imagesInStrip;

    		if(!(this.currentIndex >= start && this.currentIndex < end)) {
    			this.currentGroupIndex =  (this.currentIndex - (this.currentIndex % this.imagesInStrip)) / this.imagesInStrip;
    		}
    	}
    },

    currentIndexChanged: function(oldval, newval) {
    	if(!this.cameraImageEvent) {
    		return;
    	}
    	if(oldval !== 'undefined' && this.cameraImageEvent.images[oldval]) {
    		this.cameraImageEvent.images[oldval].classname = '';
    	}
    	if(newval !== 'undefined' && this.cameraImageEvent.images[newval]) {
    		this.cameraImageEvent.images[newval].classname = 'selected-frame';
    		this.currentImage = this.cameraImageEvent.images[this.currentIndex];
    	}
    },

    selectFrame: function(evt, detail, target) {
    	var index = evt.target.attributes['data-strip-index'].value;
    	this.currentIndex = index;
    }

  });
</script>
</polymer>
