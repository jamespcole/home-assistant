<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../components/camera-recording.html">

<polymer-element name="camera-recordings" attributes="stateObj dialogOpen recordingType hasTabs">
<template>
	<style>
		:host .camera-event-thumb {
			width: calc(95%);
			display:inline;
			cursor:pointer;
		}
		:host .camera-event-list-item {
			width: calc(33%);
			display:inline;
		}

		:host .camera-event-list {
			width: calc(100%%);
		}

		:host .message-page {
	      /*max-width: calc(100%);
	      max-height: calc(100%);*/
	      width:632px;
	      height:400px;
	    }

	    :host .camera-event-time {
	    	text-align:center;
	    }

	    @media (max-width: 620px) {
	      :host .message-page {
	        width: calc(100%);
	        height:calc(100%);
	      }

	      	:host .camera-event-time {
	    		font-size:12px;
	    	}
	    }

	    :host .list-controls {
	    	width: 100%;
	    }
	</style>
	<camera-recording cameraImageEvent="{{selectedCameraImageEvent}}" hidden?="{{!selectedCameraImageEvent}}"></camera-recording>
	<div class='camera-image-events' hidden?="{{selectedCameraImageEvent}}">

		<div class='camera-event-list' layout horizontal wrap hidden?="{{!hasRecordings}}">
			<template repeat="{{cameraImageEvent, cameraImageEventIndex in cameraImageEvents}}" id='camera_event_list'>
		      	<div class='camera-event-list-item'>
		      		<img class='camera-event-thumb' src="{{cameraImageEvent.thumbUrl}}" data-item='{{cameraImageEventIndex}}' on-click='{{selectCameraImageEvent}}' />
			      	<div class='camera-event-time'>
			      		{{cameraImageEvent.time}}
			      	</div>
		     	</div>
			</template>

			<div horizontal layout class="list-controls">
				<div>
					<paper-button on-click='{{loadNewer}}'>
						<paper-icon-button icon="chevron-left"></paper-icon-button>
						Newer
					</paper-button>
				</div>
				<div flex>
					&nbsp;
				</div>
				<div>
					<paper-button on-click='{{loadOlder}}'>
						Older
						<paper-icon-button icon="chevron-right"></paper-icon-button>
					</paper-button>
				</div>
			</div>

		</div>

		<div hidden?="{{hasRecordings}}" class="message-page">
			<p class="message-page" hidden?="{{ displayedMessage != 0}}">
				There are no recordings of this type available.
			</p>
			<p class="message-page" hidden?="{{ displayedMessage != 2}}">
				The configured camera does not support motion detection.  It may just be that there is currently no Home Assistant
				component for this specific model.
				<br /><br />
				If you are interested in adding this feature head to the Home Assistant forums
				to get started.
			</p>
		</div>
	</div>

</template>
<script>
  var storeListenerMixIn = window.hass.storeListenerMixIn;

  Polymer({
    cameraImageEvents: null,
    selectedCameraImageEvent: null,
    dialogOpen: false,
    recordingType: null, //snapshot, recording, motion
    hasRecordings: true,
    hasTabs: true,
    offset: 0,
    resultLength: 6,
    stateObj: null,
    displayedMessage: 0,

    selectCameraImageEvent: function(evt, detail, target) {
    	this.selectedCameraImageEvent = this.cameraImageEvents[evt.target.attributes['data-item'].value];
    },

    dialogOpenChanged: function(oldVal, newVal) {
    	if(!newVal) {
    		this.cameraImageEvents = null;
    		this.selectedCameraImageEvent = null;
    	}
    },

    stateObjChanged: function(oldVal, newVal) {
    	var oldEntityId = null;
    	if(oldVal) {
    		oldEntityId = oldVal.entityId;
    	}
    	if(newVal) {
    		if(newVal.entityId != oldEntityId) {
    			this.offset = 0;
	    		this.resultLength = 6;
    		}

	    	this.loadRecordings();

	    }
	    else {
	    	this.selectedCameraImageEvent = null;
	    }
	    this.displayedMessage = 0;
    },

    selectedCameraImageEventChanged: function(oldVal, newVal) {
    	//hise parent container tabs
    	if(!newVal) {
    		this.hasTabs = true;
    	}
    	else {
    		this.hasTabs = false;
    	}
    },

    cameraImageEventsChanged: function(oldVal, newVal) {
    	if(newVal && newVal.length == 0) {
    		this.hasRecordings = false;
    	}
    	else if(newVal && newVal.length > 0) {
    		this.hasRecordings = true;
    	}
    	else {
    		this.hasRecordings = false;
    	}
    	if(!this.hasRecordings) {
    		if(this.recordingType == 'motion') {
	    		if(this.stateObj && this.stateObj.attributes['is_motion_detection_supported']) {
	    			this.displayedMessage = 0;
	    		}
	    		else {
	    			this.displayedMessage = 2;
	    		}
	    	}
	    	else {
	    		this.displayedMessage = 0;
	    	}
    	}

    },

    loadRecordings: function() {
    	if(this.dialogOpen) {
	    	window.hass.callApi('GET', 'camera_recordings/' + this.stateObj.entityId + '?offset=' + this.offset + '&length=' + this.resultLength + '&type=' + this.recordingType).then(function(data) {
		        this.cameraImageEvents = data;
		    }.bind(this), function() {
		    	this.cameraImageEvents = [];
		    }.bind(this));
	    }
    },

    loadOlder: function(evt) {
    	this.offset += this.resultLength;
    	this.loadRecordings();
    },

    loadNewer: function(ect) {
    	this.offset -= this.resultLength;
    	if(this.offset < 0) {
    		this.offset = 0;
    	}
    	this.loadRecordings();
    }

  });
</script>
</polymer>


